<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> vue服务端渲染（SSR）踩坑集锦 · miyalee</title><meta name="description" content="vue服务端渲染（SSR）踩坑集锦 - Miya Lee"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="miyalee"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://github.com/miyalee" target="_blank" class="nav-list-link">GIT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">vue服务端渲染（SSR）踩坑集锦</h1><div class="post-info">Jan 3, 2018</div><div class="post-content"><p>研究ssr距现在有些时日了，本文将记录总结我当时踩过的和看到的坑，为同样在研究ssr的小伙伴节省时间成本，欢迎大佬指点补充<br><a id="more"></a></p>
<h2 id="常规三问（是什么为什么怎么做）"><a href="#常规三问（是什么为什么怎么做）" class="headerlink" title="常规三问（是什么为什么怎么做）"></a>常规三问（是什么为什么怎么做）</h2><p>懒得听解释的跳过本段直奔主题</p>
<h4 id="ssr是什么"><a href="#ssr是什么" class="headerlink" title="ssr是什么"></a>ssr是什么</h4><p>最难抽中的顶级式神。。。（误）<img src="/images/emoticon/72.gif" alt="捂脸" style="display:inline; margin:0;"></p>
<p>简单来讲，ssr是指vue中的服务端渲染</p>
<p>默认vue开发打包生成是普通的客户端渲染，将vue打包成js然后在html中引入进而渲染DOM和操作DOM。而服务端渲染是将vue渲染成html后再发送至客户端，中间会有一系列匹配工作</p>
<h4 id="为什么用ssr"><a href="#为什么用ssr" class="headerlink" title="为什么用ssr"></a>为什么用ssr</h4><p>截两张图你就明白了</p>
<p>默认方式源代码:<br><img src="/images/ssr-1.png" alt="ssr"><br>ssr方式源代码:<br><img src="/images/ssr-2.png" alt="ssr"></p>
<p>也就是说使用默认方式，当在搜索引擎搜索你的站点关键词时可能就搜不到你的站点，这对一些需要被erveryone熟知的站点是致命的。</p>
<p>除此之外服务端渲染也能更好的解决浏览器兼容的问题，并且在性能上也帮客户端做了很多事情</p>
<h4 id="如何开发ssr项目"><a href="#如何开发ssr项目" class="headerlink" title="如何开发ssr项目"></a>如何开发ssr项目</h4><p>两种方式，自己搭建或者使用官方框架<a href="https://github.com/nuxt/nuxt.js" target="_blank" rel="noopener">Nuxt.js</a>，我当时是自己搭的，参考了官方示例<a href="https://github.com/vuejs/vue-hackernews-2.0" target="_blank" rel="noopener">vue-hackernews-2.0</a>，基本方式都是相同的，打包出对应route的bundle，与template合并，生成html string，展示</p>
<h2 id="直奔主题"><a href="#直奔主题" class="headerlink" title="直奔主题"></a>直奔主题</h2><p>使用服务端渲染常见问题：</p>
<p><div class="tip" style="margin-bottom: 0">客户端展示异常，服务端报错 <code>window/alert/document is undefined</code></div><br>服务端没有<code>window/alert/document</code>这种东西，需要自行定义，建议方式引入第三方包<code>jsdom</code>辅助定义<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://github.com/vuejs/vue-hackernews-2.0/issues/52#issuecomment-255594303</span></span><br><span class="line"><span class="keyword">const</span> &#123; JSDOM &#125; = <span class="built_in">require</span>(<span class="string">'jsdom'</span>)</span><br><span class="line"><span class="keyword">const</span> dom = <span class="keyword">new</span> JSDOM(<span class="string">'&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;'</span>,</span><br><span class="line">&#123; <span class="attr">url</span>: <span class="string">'http://localhost'</span> &#125;)</span><br><span class="line"></span><br><span class="line">global.window = dom.window</span><br><span class="line">global.document = <span class="built_in">window</span>.document</span><br><span class="line">global.navigator = <span class="built_in">window</span>.navigator</span><br></pre></td></tr></table></figure></p>
<p><div class="tip" style="margin-bottom: 0">router中配置了<code>scrollBehavior</code>，客户端正常，服务端报错<code>scroll undefined</code></div><br>跟上个问题相同，需要在服务端重声明<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fixed Not-implemented error</span></span><br><span class="line"><span class="keyword">const</span> isServer = process.env.VUE_ENV === <span class="string">'server'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isServer) &#123;</span><br><span class="line">    <span class="built_in">window</span>.scrollTo = <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// do something or not</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">        scrollBehavior: <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">y</span>: <span class="number">0</span> &#125;),</span><br><span class="line">        routes: [</span><br><span class="line">            &#123; <span class="attr">path</span>: <span class="string">'/'</span>, <span class="attr">component</span>: Homepage &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><div class="tip" style="margin-bottom: 0">mismatch</div><br>使用ssr会有检查服务端渲染出的结构与直接客户端渲染的结构是否相同，不同会报<code>mismatch</code>。这种问题往往是因为比如<code>table</code>结构没有<code>tbody</code>之类的。</p>
<p>自己的一些业务操作也可能会产生两端的结构重复，比如我之前为了动态生成<code>meta</code>用了mixin，在服务端用<code>$ssrContext</code>配合操作，客户端则用的<code>document</code>直接更改对应值，因此会出现一个页面有两个重复的<code>meta</code>，造成<code>mismatch</code>，解决方式是在客户端加判断，如果已经有的<code>meta</code>就使用修改而不是增加<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (meta) &#123;</span><br><span class="line">    $.parseHTML(meta).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">    	$(<span class="string">'meta[name='</span> + $(el).attr(<span class="string">'name'</span>) + <span class="string">']'</span>)</span><br><span class="line">        	.attr(<span class="string">'content'</span>, $(el).attr(<span class="string">'content'</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><div class="tip" style="margin-bottom: 0">区别终端类型</div><br>比如在PC端使用a链接作为入口，移动端使用b链接作为入口</p>
<p>客户端：使用<code>navigator.userAgent</code>做判断，然后<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vue.mixin(&#123;</span><br><span class="line">    beforeRouteEnter(to, <span class="keyword">from</span>, next) &#123;</span><br><span class="line">        <span class="keyword">if</span>(judgeUserAgent() &amp;&amp; to.path === <span class="string">'/a/'</span> ) &#123;</span><br><span class="line">            next(<span class="string">'/b/'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>服务端： 在<code>server.js</code>的<code>render</code>中通过<code>req.headers[&#39;user-agent&#39;]</code>然后通过<code>$ssrContext</code>传递<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(context.agentID !== <span class="literal">null</span> &amp;&amp; context.url === <span class="string">'/a/'</span>) &#123;</span><br><span class="line">    router.push(<span class="string">'/b/'</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    router.push(context.url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><div class="tip" style="margin-bottom: 0">项目不在服务器对应位置的根目录而在二级目录</div><br>一般打包都打包到根目录，获取静态文件资源也从／开始，如果不是，怎么办呢？</p>
<p>其实也不难，把各种相关配置更改一下就好了，就是这些位置自己摸索到时候有些麻烦，尤其还是ssr,漏掉就可能造成项目起不来或白屏、报错、刷新404。</p>
<p>我这里列了一下要修改的位置(按文件顺序,假设二级目录名为dev)：</p>
<ul>
<li><p><code>build/setup-dev-server.js</code>中的<code>webpack-hot-middleware</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clientConfig.entry.app = [<span class="string">'webpack-hot-middleware/client?path=/dec/__webpack_hmr'</span>, clientConfig.entry.app]</span><br><span class="line"></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'webpack-hot-middleware'</span>)(clientCompiler, &#123;</span><br><span class="line">    path: <span class="string">'/dev/__webpack_hmr'</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>webpack.base.config.js</code> 的<code>output</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'../dist'</span>),</span><br><span class="line">    publicPath: <span class="string">'/dev/dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].[chunkhash].js'</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>entry-client.js</code> 的<code>service worker</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'production'</span> &amp;&amp; <span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">    navigator.serviceWorker.register(<span class="string">'/dev/service-worker.js'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>template.html</code> 的<code>href</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"/dev/assets/images/favicon.ico"</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>server.js</code> 的<code>serve</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.use(favicon(<span class="string">'./src/assets/images/favicon.ico'</span>))</span><br><span class="line">app.use(<span class="string">'/dev/dist'</span>, serve(<span class="string">'./dist'</span>, <span class="literal">true</span>))</span><br><span class="line">app.use(<span class="string">'/dev/assets'</span>, serve(<span class="string">'./src/assets'</span>, <span class="literal">true</span>))</span><br><span class="line">app.use(<span class="string">'/dev/service-worker.js'</span>, serve(<span class="string">'./dist/service-worker.js'</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果是非服务端渲染需要修改<code>config/index.js</code>中<code>assetsPublicPath</code>为<code>/dev/</code></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/11/27/blog2017-11-27/" class="next">NEXT</a></div><div data-thread-key="2018/01/03/blog2018-01-03/" data-title="vue服务端渲染（SSR）踩坑集锦" data-url="http://yoursite.com/2018/01/03/blog2018-01-03/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"miyalee"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2018 <a href="http://yoursite.com">Miya Lee</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>